<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>朱剑波</title>
  <subtitle>博客</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://github.com/MrMessy77/"/>
  <updated>2017-08-31T07:38:04.000Z</updated>
  <id>https://github.com/MrMessy77/</id>
  
  <author>
    <name>朱剑波</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>RxSwift</title>
    <link href="https://github.com/MrMessy77/2017/08/31/RxSwift/"/>
    <id>https://github.com/MrMessy77/2017/08/31/RxSwift/</id>
    <published>2017-08-31T06:56:06.000Z</published>
    <updated>2017-08-31T07:38:04.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近在研究RxSwift，希望从中收获一些有用的东西，在后期的编程中能进行更好的构架和编码。</p>
<p>这篇文章使用<strong><a href="https://github.com/ReactiveX/RxSwift">RxSwift</a></strong>和<strong><a href="https://github.com/CoderMJLee/MJRefresh">MJRefresh</a></strong>相结合来实现简单下拉和上拉的刷新。<br>为了利用更少的代码量展示更多的东西，我使用了RxDataSources，一个基于RxSwift的第三方库。<strong><a href="https://github.com/RxSwiftCommunity/RxDataSources">RxDataSources</a></strong>是一个对tableview，collectionview中的datasource进行封装的库，使datasource能够进行和RxSwift一样的响应式编程，与RxSwift能够完美的结合。</p>
<p>不多说了，直接上代码：<br>首先，我使用RxDataSources实现了一个简单的列表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">import UIKit</div><div class="line">import RxSwift</div><div class="line">import RxCocoa</div><div class="line">import RxDataSources</div><div class="line"></div><div class="line">class NewsViewModel: BaseViewModel, UITableViewDelegate &#123;</div><div class="line"></div><div class="line">/** 释放资源属性 */</div><div class="line">let disposeBag = DisposeBag()</div><div class="line">/** 资源类属性 */</div><div class="line">let dataSource = RxTableViewSectionedReloadDataSource&lt;SectionModel&lt;String,NewsModel&gt;&gt;()</div><div class="line">/** 新闻数据 */</div><div class="line">var news = [NewsModel]()</div><div class="line">var tableView: UITableView!</div><div class="line"></div><div class="line">//MARK: - 配置基础设置</div><div class="line"></div><div class="line">func prepare(tableView: UITableView) &#123;</div><div class="line">self.tableView = tableView</div><div class="line">//设置tableView的delegate</div><div class="line">tableView.rx_setDelegate(self).addDisposableTo(disposeBag)</div><div class="line"></div><div class="line">dataSource.configureCell = &#123;dataSource,tableView,indexPath,new in</div><div class="line">let cell = tableView.dequeueReusableCellWithIdentifier(&quot;NewsCell&quot;, forIndexPath: indexPath) as! NewsCell</div><div class="line">cell.config(new.dec, date: new.date)</div><div class="line">return cell</div><div class="line">&#125;</div><div class="line"></div><div class="line">//创建数据</div><div class="line">for _ in 0..&lt;9 &#123;</div><div class="line">let new = NewsModel(pic: &quot;&quot;, dec: &quot;LOL测试服：狼人皮肤调整 酒桶被动增强&quot;, date: &quot;2016-07-01&quot;)</div><div class="line">news.append(new)</div><div class="line">&#125;</div><div class="line">let sections = [</div><div class="line">SectionModel(model: &quot;&quot;, items: news)</div><div class="line">]</div><div class="line">//订阅被观察者</div><div class="line">let items = Observable.just(sections)</div><div class="line">items.bindTo(tableView.rx_itemsWithDataSource(dataSource)).addDisposableTo(disposeBag)</div><div class="line">&#125;</div><div class="line"></div><div class="line">//MARK: - UITableViewDelegate</div><div class="line"></div><div class="line">func tableView(tableView: UITableView, heightForRowAtIndexPath indexPath: NSIndexPath) -&gt; CGFloat &#123;</div><div class="line">return 94</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>效果图：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/764896-b65fdb8080e1c5de.gif?imageMogr2/auto-orient/strip" alt="rxswiftrefresh1.gif"></p>
<p>接下来，我们将使用MJRefresh进行下拉和上拉的刷新，因为考虑后期的维护，我将MJRefresh进行了近一步的封装，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">import UIKit</div><div class="line">import MJRefresh</div><div class="line"></div><div class="line">//MARK; - 自定义下拉刷新控件</div><div class="line">class CustomRefreshHeader: MJRefreshNormalHeader &#123;</div><div class="line"></div><div class="line">override func prepare() &#123;</div><div class="line">super.prepare()</div><div class="line">self.stateLabel?.font = UIFont.systemFontOfSize(14.0)</div><div class="line">self.stateLabel?.textColor = color_999999</div><div class="line">self.lastUpdatedTimeLabel.font = UIFont.systemFontOfSize(14.0)</div><div class="line">self.lastUpdatedTimeLabel?.textColor = color_999999</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//MARK; - 自定义上拉刷新控件</div><div class="line">class CustomRefreshFooter: MJRefreshAutoNormalFooter &#123;</div><div class="line"></div><div class="line">override func prepare() &#123;</div><div class="line">super.prepare()</div><div class="line">self.setTitle(&quot;正在获取数据中...&quot;, forState: MJRefreshState.Refreshing)</div><div class="line">self.setTitle(&quot;加载更多&quot;, forState: MJRefreshState.Idle)</div><div class="line">self.setTitle(&quot;没有更多&quot;, forState: MJRefreshState.NoMoreData)</div><div class="line">self.stateLabel?.font = UIFont.systemFontOfSize(14.0)</div><div class="line">self.stateLabel?.textColor = color_999999</div><div class="line">&#125;</div><div class="line"></div><div class="line">//MARK: - 隐藏footer</div><div class="line">func hideFooter() &#123;</div><div class="line">self.stateLabel?.hidden = true</div><div class="line">&#125;</div><div class="line"></div><div class="line">//MARK: - 显示footer</div><div class="line">func showFooter() &#123;</div><div class="line">self.stateLabel?.hidden = false</div><div class="line">&#125;</div><div class="line"></div><div class="line">override func placeSubviews() &#123;</div><div class="line">super.placeSubviews()</div><div class="line">let loadingView = self.subviews[1] as! UIActivityIndicatorView</div><div class="line">//圈圈</div><div class="line">var arrowCenterX = self.mj_w * 0.5</div><div class="line">if !self.refreshingTitleHidden &#123;</div><div class="line">arrowCenterX -= 80</div><div class="line">&#125;</div><div class="line">let arrowCenterY = self.mj_h * 0.5</div><div class="line">loadingView.center = CGPoint(x: arrowCenterX, y: arrowCenterY)</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在RxSwiftRefreshDemo中我们能找到RefreshManager这个类，也就是我对MJRefresh近一步封装的类。</p>
<p>接着将MJRefresh添加到tableview上，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">class BaseTableView: UIView &#123;</div><div class="line"></div><div class="line">var tableView: UITableView!</div><div class="line">var header: CustomRefreshHeader! //下拉刷新视图</div><div class="line">var footer: CustomRefreshFooter! //上拉刷新视图</div><div class="line"></div><div class="line">override init(frame: CGRect) &#123;</div><div class="line">super.init(frame: frame)</div><div class="line"></div><div class="line">self.placeSubViews()</div><div class="line">&#125;</div><div class="line"></div><div class="line">required init?(coder aDecoder: NSCoder) &#123;</div><div class="line">fatalError(&quot;init(coder:) has not been implemented&quot;)</div><div class="line">&#125;</div><div class="line"></div><div class="line">//MARK: - 放置子视图</div><div class="line"></div><div class="line">private func placeSubViews() &#123;</div><div class="line">tableView = UITableView()</div><div class="line">tableView.separatorStyle = .None</div><div class="line">tableView.backgroundColor = color_Clear</div><div class="line">tableView.tableFooterView = UIView()</div><div class="line">self.addSubview(tableView)</div><div class="line">tableView.mm_CenterEqual(self).mm_SizeEqual(self)</div><div class="line">//注册默认cell信息</div><div class="line">tableView.registerClass(BaseCell.self, forCellReuseIdentifier: &quot;BaseCell&quot;)</div><div class="line"></div><div class="line">header = CustomRefreshHeader()</div><div class="line">tableView.mj_header = header</div><div class="line"></div><div class="line">footer = CustomRefreshFooter()</div><div class="line">tableView.mj_footer = footer</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>考虑到这里是view层，我并没有设置header和footer的Action。接下来我在NewsViewModel进行MJRefresh的设置。代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">class NewsViewModel: BaseViewModel, UITableViewDelegate &#123;</div><div class="line"></div><div class="line">/** 释放资源属性 */</div><div class="line">let disposeBag = DisposeBag()</div><div class="line">/** 资源类属性 */</div><div class="line">let dataSource = RxTableViewSectionedReloadDataSource&lt;SectionModel&lt;String,NewsModel&gt;&gt;()</div><div class="line">/** 新闻数据 */</div><div class="line">var news = [NewsModel]()</div><div class="line">var tableView: UITableView!</div><div class="line"></div><div class="line">//MARK: - 配置基础设置</div><div class="line"></div><div class="line">func prepare(tableView: UITableView) &#123;</div><div class="line">self.tableView = tableView</div><div class="line">//设置tableView的delegate</div><div class="line">tableView.rx_setDelegate(self).addDisposableTo(disposeBag)</div><div class="line">tableView.mj_header.setRefreshingTarget(self, refreshingAction: #selector(refreshPageOneData))</div><div class="line">tableView.mj_footer.setRefreshingTarget(self, refreshingAction: #selector(refreshNextPageData))</div><div class="line"></div><div class="line">dataSource.configureCell = &#123;dataSource,tableView,indexPath,new in</div><div class="line">let cell = tableView.dequeueReusableCellWithIdentifier(&quot;NewsCell&quot;, forIndexPath: indexPath) as! NewsCell</div><div class="line">cell.config(new.dec, date: new.date)</div><div class="line">return cell</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//MARK: - UITableViewDelegate</div><div class="line"></div><div class="line">func tableView(tableView: UITableView, heightForRowAtIndexPath indexPath: NSIndexPath) -&gt; CGFloat &#123;</div><div class="line">return 94</div><div class="line">&#125;</div><div class="line"></div><div class="line">//MARK: - 刷新第一页数据</div><div class="line"></div><div class="line">func refreshPageOneData() &#123;</div><div class="line">self.news.removeAll()</div><div class="line">for _ in 0..&lt;9 &#123;</div><div class="line">let new = NewsModel(pic: &quot;&quot;, dec: &quot;LOL测试服：狼人皮肤调整 酒桶被动增强&quot;, date: &quot;2016-07-01&quot;)</div><div class="line">news.append(new)</div><div class="line">&#125;</div><div class="line">let sections = [</div><div class="line">SectionModel(model: &quot;&quot;, items: news)</div><div class="line">]</div><div class="line">let items = Observable.just(sections)</div><div class="line">items.bindTo(tableView.rx_itemsWithDataSource(dataSource)).addDisposableTo(disposeBag)</div><div class="line">tableView.mj_header.endRefreshing()</div><div class="line">&#125;</div><div class="line"></div><div class="line">//MARK: - 刷新下一页数据</div><div class="line"></div><div class="line">func refreshNextPageData() &#123;</div><div class="line">for _ in 0..&lt;9 &#123;</div><div class="line">let new = NewsModel(pic: &quot;&quot;, dec: &quot;LPL老将Clearlove退役 信任“七号”上线&quot;, date: &quot;2016-07-02&quot;)</div><div class="line">news.append(new)</div><div class="line">&#125;</div><div class="line">let sections = [</div><div class="line">SectionModel(model: &quot;&quot;, items: news)</div><div class="line">]</div><div class="line">let items = Observable.just(sections)</div><div class="line">tableView.mj_footer.endRefreshing()</div><div class="line">items.bindTo(tableView.rx_itemsWithDataSource(dataSource)).addDisposableTo(disposeBag)</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但是在上拉到下一页的时候出现了奔溃，提示错误：ssertion failed: This is a feature to warn you that there is already a delegate (or data source) set somewhere previously. The action you are trying to perform will clear that delegate (data source) and that means that some of your features that depend on that delegate (data source) being set will likely stop working.<br>意思是我们在下拉的时候设置了datasource的代理，不能在对tableview进行设置，如果要这样操作，需将原来的datasource设置为nil。所以我在refreshPageOneData()和refreshNextPageData()中加入了tableView.dataSource = nil。</p>
<p>效果图如下：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/764896-b33cfb8e22609b01.gif?imageMogr2/auto-orient/strip" alt="rxswiftrefresh2.gif"></p>
<p>demo地址：<a href="https://github.com/MrMessy77/RxSwiftRefreshDemo">RxSwiftRefreshDemo</a><br>此文章仅供参考。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近在研究RxSwift，希望从中收获一些有用的东西，在后期的编程中能进行更好的构架和编码。&lt;/p&gt;
&lt;p&gt;这篇文章使用&lt;strong&gt;&lt;a href=&quot;https://github.com/ReactiveX/RxSwift&quot;&gt;RxSwift&lt;/a&gt;&lt;/strong&gt;和&lt;
    
    </summary>
    
    
      <category term="swift" scheme="https://github.com/MrMessy77/tags/swift/"/>
    
  </entry>
  
</feed>
